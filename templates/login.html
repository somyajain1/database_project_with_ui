<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Email Subscription</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <nav class="bg-white shadow-lg">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between">
                <div class="flex space-x-7">
                    <div>
                        <a href="/" class="flex items-center py-4">
                            <span class="font-semibold text-gray-500 text-lg">Email Subscription</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto mt-10 px-4">
        <div class="text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">Welcome</h1>
            <p class="text-xl text-gray-600 mb-8">Please sign in to continue</p>
            
            <!-- Login Form -->
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6 mb-8">
                <div id="loginContainer" class="space-y-4">
                    <button id="googleSignIn" 
                            class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-50 transition duration-300 flex items-center justify-center space-x-2">
                        <img src="https://www.google.com/favicon.ico" alt="Google" class="w-5 h-5">
                        <span>Sign in with Google</span>
                    </button>
                </div>
                <div id="message" class="mt-4 text-center hidden">
                    <p class="text-red-500">Error message will appear here</p>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAXLKyKue10uBRenJvsC81GYQDl0eVXYHc",
            authDomain: "vibe-coding-cursor.firebaseapp.com",
            projectId: "vibe-coding-cursor",
            storageBucket: "vibe-coding-cursor.firebasestorage.app",
            messagingSenderId: "1048387694267",
            appId: "1:1048387694267:web:a8750e49028e815d47c39e"
        };

        // Initialize Firebase first, before any other operations
        console.log('Initializing Firebase...');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        console.log('Firebase initialized with auth:', auth);

        // Rest of the code in try-catch
        try {
            console.log('Current domain:', window.location.hostname);
            console.log('Current full URL:', window.location.href);
            console.log('Using authDomain:', firebaseConfig.authDomain);
            
            const provider = new GoogleAuthProvider();
            console.log('Google Auth Provider created');

            // Handle Google Sign In
            document.getElementById('googleSignIn').addEventListener('click', async () => {
                try {
                    // Show loading state
                    const messageDiv = document.getElementById('message');
                    messageDiv.querySelector('p').textContent = 'Signing in...';
                    messageDiv.classList.remove('hidden');

                    provider.setCustomParameters({
                        prompt: 'select_account'
                    });

                    console.log('Attempting sign in...');
                    const result = await signInWithPopup(auth, provider);
                    console.log('Sign in successful:', result);
                    const idToken = await result.user.getIdToken();
                    console.log('Got ID token, sending to server...');
                    await handleSignInSuccess(idToken);
                } catch (error) {
                    console.error('Sign in error:', error);
                    if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                        console.log('Popup failed, trying redirect...');
                        await signInWithRedirect(auth, provider);
                    } else {
                        const messageDiv = document.getElementById('message');
                        messageDiv.querySelector('p').textContent = error.message || 'An error occurred during sign-in';
                        messageDiv.classList.remove('hidden');
                    }
                }
            });

            // Handle redirect result
            getRedirectResult(auth).then(async (result) => {
                if (result) {
                    console.log('Got redirect result:', result);
                    const idToken = await result.user.getIdToken();
                    console.log('Got ID token from redirect');
                    await handleSignInSuccess(idToken);
                }
            }).catch((error) => {
                console.error('Redirect result error:', error);
                const messageDiv = document.getElementById('message');
                messageDiv.querySelector('p').textContent = 'Failed to complete sign-in. Please try again.';
                messageDiv.classList.remove('hidden');
            });

            // Helper function to handle successful sign-in
            async function handleSignInSuccess(idToken) {
                try {
                    console.log('Verifying token with server...');
                    const response = await fetch('/api/verify-token', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ idToken })
                    });

                    if (response.ok) {
                        console.log('Token verified, redirecting...');
                        window.location.href = '/';
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Login failed');
                    }
                } catch (error) {
                    console.error('Token verification error:', error);
                    const messageDiv = document.getElementById('message');
                    messageDiv.querySelector('p').textContent = 'Failed to verify login. Please try again.';
                    messageDiv.classList.remove('hidden');
                }
            }

        } catch (error) {
            console.error('Setup error:', error);
            const messageDiv = document.getElementById('message');
            messageDiv.querySelector('p').textContent = 'Failed to setup authentication: ' + error.message;
            messageDiv.classList.remove('hidden');
        }
    </script>
</body>
</html> 